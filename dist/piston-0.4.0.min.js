var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},ps;!function(ps){var BrowserAnimationFrameProvider=function(){function BrowserAnimationFrameProvider(){this.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback,1e3/60)}}()}return BrowserAnimationFrameProvider.prototype.animate=function(runnable){requestAnimationFrame.call(window,runnable.run.bind(runnable))},BrowserAnimationFrameProvider}();ps.BrowserAnimationFrameProvider=BrowserAnimationFrameProvider}(ps||(ps={}));var ps;!function(ps){var Entity=function(){function Entity(pos){this.pos=pos,this.vel=new ps.Vector(0,0),this.acc=new ps.Vector(0,0),this.rotation=0,this.rotationSpeed=0,this.isCollisionDetectionEnabled=!1,this.destroyOnCollision=!1,this.isAccelerationEnabled=!1,this.mass=100,this.destroyed=!1,this.isWrapping=!1}return Entity.prototype.update=function(dt,dims){this.isAccelerationEnabled&&(this.vel=this.vel.add(this.acc.multiply(dt))),0!==this.rotationSpeed&&(this.rotation=(this.rotation+this.rotationSpeed*dt)%(2*Math.PI)),this.pos=this.pos.add(this.vel.multiply(dt)),this.isWrapping&&this.wrap(dims)},Entity.prototype.wrap=function(dimensions){this.pos.x>dimensions.x&&(this.pos.x-=dimensions.x),this.pos.x<0&&(this.pos.x+=dimensions.x),this.pos.y<0&&(this.pos.y+=dimensions.y),this.pos.y>dimensions.y&&(this.pos.y-=dimensions.y)},Entity.prototype.collideWith=function(other){this.destroyOnCollision&&(this.destroyed=!0)},Entity}();ps.Entity=Entity}(ps||(ps={}));var ps;!function(ps){var collision;!function(collision){var Collision=function(){function Collision(){for(var entities=[],_i=0;_i<arguments.length;_i++)entities[_i-0]=arguments[_i];this.entities=entities}return Collision}();collision.Collision=Collision}(collision=ps.collision||(ps.collision={}))}(ps||(ps={}));var ps;!function(ps){var collision;!function(collision){var CircularCollisionDetector=function(){function CircularCollisionDetector(){}return CircularCollisionDetector.prototype.findCollisions=function(entities){for(var collidables=this.getCollisionEnabledEntities(entities),collisions=[],i=0;i<collidables.length-1;i++)for(var j=i+1;j<collidables.length;j++)this.collides(collidables[i],collidables[j])&&collisions.push(new collision.Collision(collidables[i],collidables[j]));return collisions},CircularCollisionDetector.prototype.collides=function(a,b){return a.pos.distanceTo(b.pos)<a.radius+b.radius},CircularCollisionDetector.prototype.getCollisionEnabledEntities=function(entities){return entities.filter(function(e){return e.isCollisionDetectionEnabled})},CircularCollisionDetector}();collision.CircularCollisionDetector=CircularCollisionDetector}(collision=ps.collision||(ps.collision={}))}(ps||(ps={}));var ps;!function(ps){var collision;!function(collision_1){var DeferToEntityCollisionResolver=function(){function DeferToEntityCollisionResolver(){}return DeferToEntityCollisionResolver.prototype.resolve=function(collisions){for(var _i=0,collisions_1=collisions;_i<collisions_1.length;_i++){var collision_2=collisions_1[_i];this.resolveSingleCollision(collision_2)}},DeferToEntityCollisionResolver.prototype.resolveSingleCollision=function(collision){for(var entities=collision.entities,i=0;i<entities.length-1;i++)for(var j=i+1;j<entities.length;j++)entities[i].collideWith(entities[j]),entities[j].collideWith(entities[i])},DeferToEntityCollisionResolver}();collision_1.DeferToEntityCollisionResolver=DeferToEntityCollisionResolver}(collision=ps.collision||(ps.collision={}))}(ps||(ps={}));var ps;!function(ps){var Point=function(){function Point(x,y){this.x=x,this.y=y}return Point.prototype.add=function(v){return new Point(this.x+v.x,this.y+v.y)},Point.prototype.subtract=function(p){return new Point(this.x-p.x,this.y-p.y)},Point.prototype.distanceTo=function(p){return Math.sqrt(Math.pow(this.x-p.x,2)+Math.pow(this.y-p.y,2))},Point.prototype.vectorTo=function(p){return p.subtract(this).toVector()},Point.prototype.toVector=function(){return new ps.Vector(this.x,this.y)},Point}();ps.Point=Point}(ps||(ps={}));var ps;!function(ps){var input;!function(input){var Keyboard=function(){function Keyboard(document,window){var _this=this;this.pressedKeys={},this.document=document,this.keyDownDelegate=function(e){return _this.setKey(e,!0)}.bind(this),this.keyUpDelegate=function(e){return _this.setKey(e,!1)}.bind(this),this.blurDelegate=function(e){return _this.pressedKeys={}}.bind(this)}return Keyboard.prototype.enable=function(){document.addEventListener("keydown",this.keyDownDelegate),document.addEventListener("keyup",this.keyUpDelegate),window.addEventListener("blur",this.keyUpDelegate)},Keyboard.prototype.disable=function(){document.removeEventListener("keydown",this.keyDownDelegate),document.removeEventListener("keyup",this.keyUpDelegate),window.removeEventListener("blur",this.keyUpDelegate)},Keyboard.prototype.isKeyDown=function(key){return this.pressedKeys[key.toUpperCase()]},Keyboard.prototype.setKey=function(event,status){var key,code=event.keyCode;switch(code){case 32:key="SPACE";break;case 37:key="LEFT";break;case 38:key="UP";break;case 39:key="RIGHT";break;case 40:key="DOWN";break;default:key=String.fromCharCode(code)}this.pressedKeys[key]=status},Keyboard}();input.Keyboard=Keyboard}(input=ps.input||(ps.input={}))}(ps||(ps={}));var ps;!function(ps){var input;!function(input){var Mouse=function(){function Mouse(canvas,coordConverter){this.canvas=canvas,this.coordConverter=coordConverter,this.pos=new ps.Point(0,0),this.isLeftButtonDown=!1,this.isRightButtonDown=!1,this.isMiddleButtonDown=!1,this.mouseMoveListeners=[],this.mouseDownListeners=[],this.mouseUpListeners=[],this.mouseMoveDelegate=this.onMouseMove.bind(this),this.mouseDownDelegate=this.onMouseDown.bind(this),this.mouseUpDelegate=this.onMouseUp.bind(this)}return Mouse.prototype.enable=function(){document.body.oncontextmenu=function(e){return!1},this.canvas.style.cursor="none",this.canvas.addEventListener("mousemove",this.mouseMoveDelegate,!1),this.canvas.addEventListener("mousedown",this.mouseDownDelegate,!1),this.canvas.addEventListener("mouseup",this.mouseUpDelegate,!1)},Mouse.prototype.disable=function(){document.body.oncontextmenu=function(e){return!0},this.canvas.style.cursor="default",this.canvas.removeEventListener("mousemove",this.mouseMoveDelegate,!1),this.canvas.removeEventListener("mousedown",this.mouseDownDelegate,!1),this.canvas.removeEventListener("mouseup",this.mouseUpDelegate,!1)},Mouse.prototype.setCustomCursor=function(url,hotspot){this.canvas.style.cursor="url("+url+") "+hotspot.x+" "+hotspot.y+", auto"},Mouse.prototype.addMouseMoveEventListener=function(action){this.mouseMoveListeners.push(action)},Mouse.prototype.onMouseMove=function(e){var newPos=new ps.Point(e.clientX,e.clientY);this.pos=this.coordConverter.toGameCoords(newPos.subtract(this.findPos(this.canvas)));for(var _i=0,_a=this.mouseMoveListeners;_i<_a.length;_i++){var listener=_a[_i];listener(this.pos)}},Mouse.prototype.addMouseDownEventListener=function(action){this.mouseDownListeners.push(action)},Mouse.prototype.onMouseDown=function(e){e.stopImmediatePropagation(),0===e.button?this.isLeftButtonDown=!0:1===e.button?this.isRightButtonDown=!0:2===e.button&&(this.isMiddleButtonDown=!0);for(var _i=0,_a=this.mouseDownListeners;_i<_a.length;_i++){var listener=_a[_i];listener(this.pos,e.button)}},Mouse.prototype.addMouseUpEventListener=function(action){this.mouseUpListeners.push(action)},Mouse.prototype.onMouseUp=function(e){e.stopImmediatePropagation(),0===e.button?this.isLeftButtonDown=!1:1===e.button?this.isRightButtonDown=!1:2===e.button&&(this.isMiddleButtonDown=!1);for(var _i=0,_a=this.mouseUpListeners;_i<_a.length;_i++){var listener=_a[_i];listener(this.pos,e.button)}},Mouse.prototype.findPos=function(obj){var curleft=0,curtop=0;if(obj.offsetParent)do curleft+=obj.offsetLeft,curtop+=obj.offsetTop;while(obj=obj.offsetParent);return new ps.Point(curleft,curtop)},Mouse}();input.Mouse=Mouse}(input=ps.input||(ps.input={}))}(ps||(ps={}));var ps;!function(ps){var DateNowStopwatch=function(){function DateNowStopwatch(){this.start()}return DateNowStopwatch.prototype.start=function(){this.startTime=Date.now()},DateNowStopwatch.prototype.stop=function(){return(Date.now()-this.startTime)/1e3},DateNowStopwatch}();ps.DateNowStopwatch=DateNowStopwatch}(ps||(ps={}));var ps;!function(ps){var Vector=function(){function Vector(x,y){this.x=x,this.y=y}return Vector.prototype.add=function(v){return new Vector(this.x+v.x,this.y+v.y)},Vector.prototype.subtract=function(v){return new Vector(this.x-v.x,this.y-v.y)},Vector.prototype.multiply=function(scalar){return new Vector(this.x*scalar,this.y*scalar)},Vector.prototype.magnitude=function(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))},Vector.prototype.unit=function(){return this.multiply(1/this.magnitude())},Vector.prototype.tangent=function(){return new Vector(0===this.y?0:this.y*-1,this.x)},Vector.prototype.dot=function(v){return this.x*v.x+this.y*v.y},Vector.prototype.toPoint=function(){return new ps.Point(this.x,this.y)},Vector}();ps.Vector=Vector}(ps||(ps={}));var ps;!function(ps){var DefaultCoordConverter=function(){function DefaultCoordConverter(dims){this.dims=dims}return DefaultCoordConverter.prototype.toCameraCoords=function(p){return new ps.Point(p.x,this.dims.y-p.y)},DefaultCoordConverter.prototype.toGameCoords=function(p){return new ps.Point(p.x,this.dims.y-p.y)},DefaultCoordConverter.prototype.setDims=function(dims){this.dims=dims},DefaultCoordConverter}();ps.DefaultCoordConverter=DefaultCoordConverter}(ps||(ps={}));var ps;!function(ps){var Camera=function(){function Camera(dims,ctx,coordConverter){this.dims=dims,this.ctx=ctx,this.coordConverter=coordConverter,this.backgroundColor="black"}return Camera.prototype.fillCircle=function(pos,radius,color){this.fillArc(pos,0,radius,0,2*Math.PI,!1,color)},Camera.prototype.fillArc=function(pos,rotation,radius,startAngle,endAngle,counterClockWise,color){var _this=this,centerCC=this.coordConverter.toCameraCoords(pos),scaledRadius=this.scale(radius);this.paintWhileRotated(centerCC,rotation,function(){_this.ctx.fillStyle=color,_this.ctx.beginPath(),_this.ctx.arc(0,0,scaledRadius,startAngle,endAngle,counterClockWise),_this.ctx.fill(),_this.ctx.closePath()})},Camera.prototype.fillRect=function(pos,rotation,width,height,color){var _this=this,centerCC=this.coordConverter.toCameraCoords(pos),scaledHeight=this.scale(height),scaledWidth=this.scale(width);this.paintWhileRotated(centerCC,rotation,function(){_this.ctx.fillStyle=color,_this.ctx.fillRect(-scaledWidth/2,-scaledHeight/2,scaledWidth,scaledHeight)})},Camera.prototype.drawLine=function(start,end,lineWidth,color){var startCC=this.coordConverter.toCameraCoords(start),endCC=this.coordConverter.toCameraCoords(end),previousStroke=this.ctx.strokeStyle,previousLineWidth=this.ctx.lineWidth;this.ctx.beginPath(),this.ctx.strokeStyle=color,this.ctx.lineWidth=lineWidth,this.ctx.moveTo(startCC.x,startCC.y),this.ctx.lineTo(endCC.x,endCC.y),this.ctx.closePath(),this.ctx.stroke(),this.ctx.strokeStyle=previousStroke,this.ctx.lineWidth=previousLineWidth},Camera.prototype.paintSprite=function(pos,rotation,size,sprite){this.paintSprites(pos,rotation,size,[sprite])},Camera.prototype.paintSprites=function(pos,rotation,size,sprites){for(var centerCC=this.coordConverter.toCameraCoords(pos),scaledSize=[this.scale(size[0]),this.scale(size[1])],_i=0,sprites_1=sprites;_i<sprites_1.length;_i++){var sprite=sprites_1[_i];this.paintSpriteInternal(sprite,centerCC,scaledSize,rotation)}},Camera.prototype.paintSpriteInternal=function(sprite,pos,size,rotation){sprite.render(this.ctx,this.resourceManager,pos,size,rotation)},Camera.prototype.scale=function(n){return n},Camera.prototype.render=function(entities){this.clear();for(var _i=0,entities_1=entities;_i<entities_1.length;_i++){var entity=entities_1[_i];entity.render(this)}},Camera.prototype.clear=function(){this.ctx.fillStyle=this.backgroundColor,this.ctx.fillRect(0,0,this.dims.x,this.dims.y)},Camera.prototype.paintWhileRotated=function(center,rotation,paintDelegate){this.ctx.translate(center.x,center.y),this.ctx.rotate(rotation),paintDelegate(),this.ctx.rotate(-rotation),this.ctx.translate(-center.x,-center.y)},Camera}();ps.Camera=Camera}(ps||(ps={}));var ps;!function(ps){var ResourceManager=function(){function ResourceManager(){this.cache={},this.readyCallbacks=[]}return ResourceManager.prototype.preload=function(urls){for(var _this=this,_loop_1=function(url){if(!this_1.cache[url]){var img_1=new Image;img_1.onload=function(){if(_this.cache[url]=img_1,_this.isReady())for(var _i=0,_a=_this.readyCallbacks;_i<_a.length;_i++){var cb=_a[_i];cb()}},this_1.cache[url]=!1,img_1.src=url}},this_1=this,_i=0,urls_1=urls;_i<urls_1.length;_i++){var url=urls_1[_i];_loop_1(url)}},ResourceManager.prototype.get=function(url){return this.cache[url]},ResourceManager.prototype.onReady=function(callback){this.readyCallbacks.push(callback)},ResourceManager.prototype.isReady=function(){for(var k in this.cache)if(this.cache.hasOwnProperty(k)&&!this.cache[k])return!1;return!0},ResourceManager}();ps.ResourceManager=ResourceManager}(ps||(ps={}));var ps;!function(ps){var HeadlessEngine=(ps.collision,function(){function HeadlessEngine(dims,canvas,mouse,keyboard,animator,camera){this.dims=dims,this.canvas=canvas,this.mouse=mouse,this.keyboard=keyboard,this.animator=animator,this.camera=camera,this.debug=!1,this.backgroundFillStyle="black",this.collisionDetector=new ps.collision.CircularCollisionDetector,this.collisionResolver=new ps.collision.DeferToEntityCollisionResolver,this.stopwatch=new ps.DateNowStopwatch,this.entities=[],this.isFullScreen=!1,this.resourceManager=new ps.ResourceManager,this.resources=[],this.ctx=canvas.getContext("2d"),this.camera.resourceManager=this.resourceManager,this.mouse&&this.mouse.enable(),this.keyboard&&this.keyboard.enable()}return HeadlessEngine.prototype.setDimensions=function(dims){this.dims=dims,this.camera.dims=dims,this.mouse.coordConverter.setDims(dims),this.camera.coordConverter.setDims(dims)},HeadlessEngine.prototype.registerEntity=function(){for(var entities=[],_i=0;_i<arguments.length;_i++)entities[_i-0]=arguments[_i];for(var _a=0,entities_2=entities;_a<entities_2.length;_a++){var entity=entities_2[_a];entity.engine=this,this.entities.push(entity)}},HeadlessEngine.prototype.run=function(){var dt=this.stopwatch.stop();this.garbageCollect(),this.update(dt,this.entities),this.checkCollisions(this.entities),this.camera.render(this.entities),this.stopwatch.start(),this.animator.animate(this)},HeadlessEngine.prototype.preloadResources=function(){for(var resources=[],_i=0;_i<arguments.length;_i++)resources[_i-0]=arguments[_i];this.resources=resources},HeadlessEngine.prototype.start=function(){var _this=this;this.resources.length>0?(this.resourceManager.onReady(function(){_this.animator.animate(_this)}),this.resourceManager.preload(this.resources)):this.animator.animate(this)},HeadlessEngine.prototype.checkCollisions=function(entities){var collisions=this.collisionDetector.findCollisions(entities);this.collisionResolver.resolve(collisions)},HeadlessEngine.prototype.update=function(dt,entities){for(var _i=0,entities_3=entities;_i<entities_3.length;_i++){var entity=entities_3[_i];entity.update(dt,this.dims)}},HeadlessEngine.prototype.garbageCollect=function(){this.entities=this.entities.filter(function(e){return!e.destroyed})},HeadlessEngine.prototype.toggleFullScreen=function(){},HeadlessEngine}());ps.HeadlessEngine=HeadlessEngine;var Engine=function(_super){function Engine(dims,canvas){_super.call(this,dims,canvas,new ps.input.Mouse(canvas,new ps.DefaultCoordConverter(dims)),new ps.input.Keyboard(document,window),new ps.BrowserAnimationFrameProvider,new ps.Camera(dims,canvas.getContext("2d"),new ps.DefaultCoordConverter(dims)))}return __extends(Engine,_super),Engine.prototype.toggleFullScreen=function(){if(!this.isFullScreen){this.canvas.webkitRequestFullscreen();var newWidth=screen.width,newHeight=screen.height;this.canvas.width=newWidth,this.canvas.height=newHeight,this.setDimensions(new ps.Vector(newWidth,newHeight)),this.isFullScreen=!0}},Engine}(HeadlessEngine);ps.Engine=Engine}(ps||(ps={}));var ps;!function(ps){var Sprite=function(){function Sprite(spriteSheetCoordinates,spriteSize,frames,animationSpeed,url){this.spriteSheetCoordinates=spriteSheetCoordinates,this.spriteSize=spriteSize,this.frames=frames,this.animationSpeed=animationSpeed,this.url=url,this.index=0,this.index=Math.random()*frames.length}return Sprite.prototype.update=function(dt){this.index=this.index+this.animationSpeed*dt%this.frames.length},Sprite.prototype.render=function(ctx,resourceManager,pos,size,rotation){var frame=0;if(this.animationSpeed>0){var idx=Math.floor(this.index);frame=this.frames[idx%this.frames.length]}var sprite_x=this.spriteSheetCoordinates.x+frame*this.spriteSize[0],sprite_y=this.spriteSheetCoordinates.y;0===rotation?ctx.drawImage(resourceManager.get(this.url),sprite_x,sprite_y,this.spriteSize[0],this.spriteSize[1],pos.x-size[0]/2,pos.y-size[1]/2,size[0],size[1]):(ctx.translate(pos.x,pos.y),ctx.rotate(rotation),ctx.drawImage(resourceManager.get(this.url),sprite_x,sprite_y,this.spriteSize[0],this.spriteSize[1],-size[0]/2,-size[1]/2,size[0],size[1]),ctx.rotate(-rotation),ctx.translate(-pos.x,-pos.y))},Sprite}();ps.Sprite=Sprite}(ps||(ps={}));var ps;!function(ps){var EntityWithSprites=function(_super){function EntityWithSprites(){_super.apply(this,arguments),this.sprites=[]}return __extends(EntityWithSprites,_super),EntityWithSprites.prototype.update=function(dt,dims){_super.prototype.update.call(this,dt,dims);for(var _i=0,_a=this.sprites;_i<_a.length;_i++){var sprite=_a[_i];sprite.update(dt)}},EntityWithSprites}(ps.Entity);ps.EntityWithSprites=EntityWithSprites}(ps||(ps={}));